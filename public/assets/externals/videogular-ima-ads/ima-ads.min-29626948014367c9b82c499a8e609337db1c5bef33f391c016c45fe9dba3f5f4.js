"use strict";angular.module("com.2fdevs.videogular.plugins.imaads",[]).directive("vgImaAds",["$window","VG_STATES",function(e,n){return{restrict:"E",require:"^videogular",scope:{vgNetwork:"=",vgUnitPath:"=",vgCompanion:"=",vgCompanionSize:"=",vgAdTagUrl:"=",vgSkipButton:"="},link:function(t,i,o,a){function d(e){e&&(a.mediaElement[0].addEventListener("ended",C),y.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,l,!1,this),y.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,m,!1,this),t.vgCompanion&&googletag.cmd.push(function(){googletag.defineSlot("/"+t.vgNetwork+"/"+t.vgUnitPath,t.vgCompanionSize,t.vgCompanion).addService(googletag.companionAds()).addService(googletag.pubads()),googletag.companionAds().setRefreshUnfilledSlots(!0),googletag.pubads().enableVideoAds(),googletag.enableServices()}))}function g(e){switch(e){case n.PLAY:w||(a.pause(),T.initialize(),s(t.vgAdTagUrl),w=!0);break;case n.STOP:y.contentComplete()}}function s(n){f();var t=new google.ima.AdsRequest,o=e.getComputedStyle(i[0]);t.adTagUrl=n,t.linearAdSlotWidth=parseInt(o.width,10),t.linearAdSlotHeight=parseInt(o.height,10),t.nonLinearAdSlotWidth=parseInt(o.width,10),t.nonLinearAdSlotHeight=parseInt(o.height,10),y.requestAds(t)}function l(e){f(),R=e.getAdsManager(a.mediaElement[0]),r(R)}function r(e){h=a.videogularElement[0].offsetWidth,L=a.videogularElement[0].offsetHeight,e.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,c,!1,this),e.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,v,!1,this),e.addEventListener(google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED,E,!1,this),e.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,p,!1,this),e.addEventListener(google.ima.AdEvent.Type.COMPLETE,A,!1,this),e.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,m,!1,this),e.init(h,L,google.ima.ViewMode.NORMAL),e.start()}function E(){var e=R.getAdSkippableState();e?k.css("display","block"):k.css("display","none")}function u(){R.skip()}function c(){f(),a.mediaElement[0].removeEventListener("ended",C),a.pause()}function v(){a.mediaElement[0].addEventListener("ended",C),a.play(),S()}function m(){R&&R.destroy(),S(),a.play()}function p(){S(),a.stop()}function A(){_++}function f(){i.css("display","block")}function S(){i.css("display","none")}var h,L,T=new google.ima.AdDisplayContainer(i[0]),y=new google.ima.AdsLoader(T),R=null,w=!1,C=function(){y.contentComplete()},_=0,k=angular.element(t.vgSkipButton);k.bind("click",u),i.prepend(k),angular.element(e).bind("resize",function(){h=a.videogularElement[0].offsetWidth,L=a.videogularElement[0].offsetHeight,R&&(a.isFullScreen?R.resize(h,L,google.ima.ViewMode.FULLSCREEN):R.resize(h,L,google.ima.ViewMode.NORMAL))}),t.$watch(function(){return a.isReady},function(e,n){(1==a.isReady||e!=n)&&d(e)}),t.$watch(function(){return a.currentState},function(e,n){e!=n&&g(e)})}}}]);